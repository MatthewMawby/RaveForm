<!DOCTYPE html>
<html>
<title>RaveForm</title>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="assets/raveform_banner.png" type="image/x-icon" />
    <!-- link rel="stylesheet" type="text/css" href="stylesheet.css" / -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</head>

<body style="max-width:100%; max-height: 100%;">
<!-- Navbar -->
<nav class="navbar navbar-fixed-top navbar-inverse">
  <div class="container-fluid">
    <a class="navbar-brand" href="#home">
      <span>
        <img class="gravatar" width="30" height="30" src="assets/raveform_banner.png"/>
      </span>
      Rave<b>Form</b>
    </a>
  </div>
</nav>

<div class="content" style="background-color: black; height:100%; width:100%">
    <canvas id="viz" width="100%" height="10%" style="background-color: black;"></canvas>
</div>

<script>
window.requestAnimationFrame = 	 window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
context = new AudioContext();
    var analyser = context.createAnalyser();
    var biquadFilter = context.createBiquadFilter();
    analyser.fftsize = 512; //low resolution, but fast computation
    analyser.smoothingTimeConstant = 0; //Important not to blend fft data - we want distinct frequencies for color change
    //get 'mixed audio' stream from sound card
    navigator.getMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
    navigator.getMedia({
        audio: true,
        video: false
    }, function (localMediaStream) {
        source = context.createMediaStreamSource(localMediaStream);
        source.connect(analyser);
        //source.connect(biquadFilter);
        //biquadFilter.type = "lowpass";
        //biquadFilter.connect(analyser);
        sendHueData();
    }, function (err) {
        console.log(err);
    });

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function sendHueData() {
        //get frequency data from analyser node
        var bufferLength = analyser.frequencyBinCount;
        var hueData = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(hueData);

        //find the dominant frequency bin
        var max = 0;
        var index = -1;
        for (var i = 0; i < bufferLength; i++)
        {
            if (hueData[i]>max)
            {
                max = hueData[i];
                index = i;
            }
        }

        //calculate the dominant frequency
        var frequency = (index * 44100)/ 2048.0;
        console.log(frequency);

        //construct json with data
        var hueJSON = {
            "hue" : Math.min(frequency/1250, 1),
            "brightness" : 100
        };

        //post freq data to server
        $.ajax({
            url: '/hueData',
            type: 'POST',
            dataType: 'json',
            data: JSON.stringify(hueJSON),
            contentType: "application/json",
            success: function(data){
                console.log('data sent!');
            }
        });

        //wait 333ms & repeat
        await sleep(333);
        requestAnimationFrame(sendHueData);
    }
</script>

</body>
</html>
