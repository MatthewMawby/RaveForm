<!DOCTYPE html>
<html>
<title>RaveForm</title>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="assets/raveform_banner.png" type="image/x-icon" />
    <!-- link rel="stylesheet" type="text/css" href="stylesheet.css" / -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</head>

<body style="max-width:100%; height:100vh;">
<!-- Navbar -->
<nav class="navbar navbar-fixed-top navbar-inverse">
  <div class="container-fluid">
    <a class="navbar-brand" href="#home">
      <span>
        <img class="gravatar" width="30" height="30" src="assets/raveform_banner.png"/>
      </span>
      Rave<b>Form</b>
    </a>
  </div>
</nav>


<div style="background-color: white; width:100%; height: 256px; position: relative; top: 50%; transform: translateY(-50%);">
    <canvas id="viz" style="background-color: white; height: 256px;"></canvas>
</div>

<script>
function resizeviz(){
    var viz = document.getElementById("viz");
    var rect = viz.parentNode.getBoundingClientRect();
    viz.width = rect.width;
}

window.onresize = function(){
    resizeviz();
};

window.onload = function(){
    resizeviz();
};


    window.requestAnimationFrame = 	 window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
    context = new AudioContext();
    //set context for viz
    var ctx = document.getElementById('viz').getContext('2d');
    //create rainbow gradient and set fill style
    var gradient = ctx.createLinearGradient(0,0,0,256);
    gradient.addColorStop(0.7, '#FF0000');
    gradient.addColorStop(0.6, '#FF7F00');
    gradient.addColorStop(0.5, '#FFFF00');
    gradient.addColorStop(0.4, '#00FF00');
    gradient.addColorStop(0.3, '#0000FF');
    gradient.addColorStop(0.2, '#4B0082');
    gradient.addColorStop(1, '#9400D3');
    ctx.fillStyle = gradient;

    //create AudioNodes and set properties
    var analyser = context.createAnalyser();
    var biquadFilter = context.createBiquadFilter();
    analyser.fftsize = 512; //low resolution, but fast computation
    analyser.smoothingTimeConstant = 0; //Important not to blend fft data - we want distinct frequencies for color change
    var vizAnalyser = context.createAnalyser();
    vizAnalyser.fftsize=2048;
    vizAnalyser.smoothingTimeConstant=.95; //smoothing time is important for vizualization
    //get 'mixed audio' stream from sound card
    navigator.getMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);
    navigator.getMedia({
        audio: true,
        video: false
    }, function(localMediaStream) {
        //connect audio nodes
        source = context.createMediaStreamSource(localMediaStream);
        source.connect(analyser);
        source.connect(vizAnalyser)
        //source.connect(biquadFilter);
        //biquadFilter.type = "lowpass";
        //biquadFilter.connect(analyser);
        //process audio streams
        sendHueData();
        draw();
    }, function(err) {
        console.log(err);
    });


    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function draw() {
        //get frequency data from analyser node
        var bufferLength = vizAnalyser.frequencyBinCount;
        var hueData = new Uint8Array(bufferLength);
        vizAnalyser.getByteFrequencyData(hueData);
        var viz = document.getElementById("viz");

        ctx.clearRect(0, 0, viz.width, 256);
        for (var i = 0; i < bufferLength; i++)
        {
            ctx.fillRect(i * 2, 256-hueData[i], 2, 2);
        }
        requestAnimationFrame(draw);
    }

    async function sendHueData() {
        //get frequency data from analyser node
        var bufferLength = analyser.frequencyBinCount;
        var hueData = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(hueData);

        //find the dominant frequency bin
        var max = 0;
        var index = -1;
        for (var i = 0; i < bufferLength; i++)
        {
            if (hueData[i]>max)
            {
                max = hueData[i];
                index = i;
            }
        }

        //calculate the dominant frequency
        var frequency = (index * 44100)/ 2048.0;
        console.log(frequency);

        //construct json with data
        var hueJSON = {
            "hue" : Math.min(frequency/1250, 1),
            "brightness" : 100
        };

        //post freq data to server
        $.ajax({
            url: '/hueData',
            type: 'POST',
            dataType: 'json',
            data: JSON.stringify(hueJSON),
            contentType: "application/json",
            success: function(data){
                console.log('data sent!');
            }
        });

        //wait 333ms & repeat
        await sleep(400);
        requestAnimationFrame(sendHueData);
        }
</script>

</body>
</html>
